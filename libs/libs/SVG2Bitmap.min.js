function SVG2Bitmap(e,t,n){"use strict";if(n||(n={}),(!n.scale||n.scale<0)&&(n.scale=1),!e||!e.nodeName)return void console.error("Wrong arguments : should be \n SVG2Bitmap(SVGElement, function([canvasElement],[dataURL]) || IMGElement || CanvasElement [, {parameters})");var r,a=function(){this.removeEventListener("load",a),SVG2Bitmap(this,t,n)};if("OBJECT"===e.nodeName||"IFRAME"===e.nodeName){if(!e.contentDocument||"complete"===e.contentDocument.readyState&&!e.contentDocument.documentElement)return void console.error("Unable to access the svg node : make sure it comes from the same domain or that the container has finished loading");if("complete"!==e.contentDocument.readyState)return void e.addEventListener("load",a);r=e,e=e.contentDocument.documentElement}else if("EMBED"===e.nodeName&&e.getSVGDocument&&(r=e,e=e.getSVGDocument(),!e))return r.addEventListener("load",a),r.onerror=function(){console.error("Unable to access the svg node : make sure it comes from the same domain or that the container has finished loading")},void(r.src=r.src);if("svg"!==e.nodeName){var o=e.querySelector("svg");if(!o){var i='[src*=".svg"]',l=e.querySelector("iframe"+i+", embed"+i)||e.querySelector('object[data*=".svg"]');return l?void SVG2Bitmap(l,t,n):void console.error("unable to access the svg node, make sure it has been appended to the document")}e=o}var s,c="http://www.w3.org/1999/xlink",u="http://www.w3.org/2000/svg",h=e.cloneNode(!0),d=function(){s=h.querySelector("defs")||document.createElementNS(u,"defs"),s.parentNode||h.insertBefore(s,h.firstElementChild)},m=function(){var e=document.createElement("canvas"),t=e.getContext("2d");e.width=e.height=1;var n=function(n){var r=!1;t.drawImage(n,0,0);try{e.toDataURL()}catch(a){r=!0,e=e.cloneNode(!0),t=e.getContext("2d")}return r},r=document.implementation.createHTMLDocument("test"),a=document.createElement("base");r.head.appendChild(a);var o=document.createElement("a");r.body.appendChild(o);var i=function(e,t){return a.href=t,o.href=e,o};return{isTainted:n,URL:i}}(),f=function(){var a=r?r.getBoundingClientRect():e.getBoundingClientRect();1!==e.width.baseVal.unitType&&h.setAttribute("width",a.width),1!==e.height.baseVal.unitType&&h.setAttribute("height",a.height);var o;if("undefined"!=typeof ActiveXObject){var i=function(e){for(var t=Array.prototype.slice.call(e.attributes),n=0;n<t.length;n++){var r=t[n].name;r.indexOf(":")>-1&&r.indexOf("xlink")<0&&e.removeAttribute(r)}};i(h);for(var l=h.querySelectorAll("*"),s=0;s<l.length;s++)i(l[s])}h.removeAttribute("style"),o=(new XMLSerializer).serializeToString(h);var c="data:image/svg+xml; charset=utf8, "+encodeURIComponent(o),u=new Image,d=function(){var o=t&&"CANVAS"===t.nodeName?t:document.createElement("canvas");if(o.originalSVG=r||e,o.width=a.width*n.scale,o.height=a.height*n.scale,!o.width||!o.height)return void console.error("The document is not visible and can not be rendered");var i=o.getContext("2d");n.backgroundColor&&(i.fillStyle=n.backgroundColor,i.fillRect(0,0,o.width,o.height));var l=n.scale,s=r?e.getBoundingClientRect():{top:0,left:0};try{i.drawImage(this,s.left,s.top,this.width*l||o.width,this.height*l||o.height)}catch(c){setTimeout(d.bind(this),200)}return t||(t=function(t){var n=r||e;n.parentNode.replaceChild(t,n)}),m.isTainted(o)?(console.warn("Your browser has tainted the canvas."),void("IMG"===t.nodeName?t.parentNode.replaceChild(o,t):(o.setAttribute("style",g(o)),t!==o&&t.appendChild?t.appendChild(o):"function"==typeof t&&t(o,null)))):void("IMG"===t.nodeName?(t.setAttribute("style",g(t)),t.src=o.toDataURL(n.type,n.quality)):(o.setAttribute("style",g(o)),t!==o&&t.appendChild?t.appendChild(o):"function"==typeof t&&t(o,o.toDataURL(n.type,n.quality))))},f=function(e){console.error("Couldn't export svg, please check that the svgElement passed is a valid svg document.")};u.onload=d,u.onerror=f,u.src=c},v=function(){var t,n=[],r=[],a=e.ownerDocument.styleSheets;for(t=0;t<a.length;t++)r.push(a[t]);for(r.length&&(d(),e.matches=e.matches||e.webkitMatchesSelector||e.mozMatchesSelector||e.msMatchesSelector||e.oMatchesSelector),t=0;t<r.length;t++){var o,i=r[t];try{o=i.cssRules}catch(l){continue}for(var c=document.createElement("style"),u=o&&o.length,f=0;u>f;f++){var v=o[f].selectorText;if(v&&(e.matches&&e.matches(v)||e.querySelector(v))){for(var g=o[f].cssText,p=new RegExp(/url\((.*?)\)/g),b=[];null!==(b=p.exec(g));){var E=b[1].replace(/\"/g,""),y=i.href||location.href;n.push([E,y]);var S=m.URL(E,y),x=y===location.href&&E.indexOf(".svg")<0?S.hash:S.href.substring(S.href.lastIndexOf("/")+1),C="#"+x.replace(/\//g,"_").replace(/\./g,"_").replace("#","_");g=g.replace(E,C)}c.innerHTML+=g+"\n"}}c.innerHTML&&s.appendChild(c)}var N=h.style;N.border=N.padding=N.margin=0,N.transform="initial",w(n)},g=function(t){var n=t.cloneNode(!0);e.parentNode.documentElement?e.parentNode.documentElement.appendChild(n):e.parentNode.insertBefore(n,e);for(var a=getComputedStyle(n),o=getComputedStyle(r||e),i="",l=0;l<o.length;l++)"width"!==o[l]&&"height"!==o[l]&&o[o[l]]!==a[o[l]]&&(i+=o[l]+":"+o[o[l]]+";");return n.parentNode.removeChild(n),i},p=function(){var t,r=h.querySelectorAll("image"),a=r.length,o=0;if(0===a)return void f();var i=[],l=e.querySelectorAll("image");for(t=0;t<r.length;t++)if(l[t]&&l[t].isEqualNode(r[t]))i.push(l[t]);else{for(var s=null,u=0;u<l.length;u++)if(l[u].isEqualNode(r[t])){s=l[u];break}i.push(s)}var d=function(e,t,n){var r=e.width,a=e.height,o=t.width,i=t.height,l=function(e){var t=a/r,n=i/o,l=n>t?o:i/t,s=n>t?o*t:i,h=function(e,t,n){var r=Math.max(t,n),a=Math.min(t,n);switch(e){case"Min":return 0;case"Mid":return(r-a)/2;case"Max":return r-a;default:return"invalid"}},d=[c,0,0,r,a,h(e[0],l,o),h(e[1],s,i),l,s];return"invalid"===d[5]||"invalid"===d[6]?u:d},s=function(e){var t,n,l=function(){t=o,n=a*o/r},s=function(){t=r*i/a,n=i};o>i?(l(),i>n&&s()):o===i?r>a?s():l():(s(),o>t&&l());var h=function(e,t,n,r){switch(e){case"Min":return 0;case"Mid":return(t-n)/2*r/t;case"Max":return(t-n)*r/t;default:return"invalid"}},d=h(e[0],t,o,r),m=h(e[1],n,i,a),f=[c,d,m,r-d,a-m,0,0,t-d*(t/r),n-m*(n/a)];return"invalid"===f[1]||"invalid"===f[2]?u:f},c="IMG"===e.nodeName||"VIDEO"===e.nodeName||"CANVAS"===e.nodeName?e:null,u=l(["Mid","Mid"]);if(!n)return u;var h=n.trim().split(" "),d=h[0].replace("x","").split("Y");switch(h[h.length-1]){case"meet":return l(d);case"slice":return s(d);default:return u}},v=document.createElement("canvas"),g=v.getContext("2d"),p=function(e){var t=new Image;t.onload=function(){++o===a&&f()},t.src=e},w=function(e,t){var r=new Image,i=function(){console.warn("failed to load an image at : ",r.src),n.keepImageHolder||e.parentNode.removeChild(e),--a===o&&f()};n.noCORS||(r.crossOrigin="Anonymous"),r.onload=function(){var r,a;if(t&&(r=e.getAttribute("preserveAspectRatio"),a=t.getBoundingClientRect()),t&&a&&(a.width*n.scale<this.width||a.height*n.scale<this.height)){v.width=a.width*n.scale,v.height=a.height*n.scale;var o=d(this,v,r);g.drawImage.apply(g,o)}else v.width=this.width,v.height=this.height,g.drawImage(this,0,0);if(m.isTainted(v))return void i();var l=v.toDataURL();e.setAttributeNS(c,"href",l),p(l)},r.onerror=function(){var e=this.src;this.onerror=i,this.removeAttribute("crossorigin"),this.src="",this.src=e},r.src=e.getAttributeNS(c,"href")},b=function(e,t){var n=new XMLHttpRequest;n.onload=function(){if(200===this.status){var e=this.responseText||this.response,n="data:image/svg+xml; charset=utf8, "+encodeURIComponent("<svg"+e.split("<svg")[1]);t.setAttributeNS(c,"href",n),p(n)}else w(t)},n.onerror=function(){w(t)};try{n.open("GET",e)}catch(r){return void w(t)}n.send()};for(t=0;t<r.length;t++){var E=r[t].getAttributeNS(c,"href");if(E&&E.indexOf("data:image")<0)E.indexOf(".svg")>0?b(E,r[t]):w(r[t],i[t]);else if(++o===a)return void f()}},w=function(t){var n,r=0,a=0,o={href:location.href.replace(location.hash,"").replace(/#/g,""),pathname:location.pathname,filename:"",innerElements:[],parsedElements:[],doc:e.ownerDocument,base:location.href.replace(location.hash,"").replace(/#/g,"")},i=[o],l=function(){var e=document.createElementNS(u,"use");e.setAttributeNS(c,"href","#__#"),h.appendChild(e);var t=!!h.querySelector('[*|href*="#"]');return h.removeChild(e),t}(),f=function(e){return l?e.querySelectorAll('[*|href*="#"]'):function(){var t=[],r=e.querySelectorAll("*");for(n=0;n<r.length;n++){var a=r[n].getAttributeNS(c,"href");a&&a.indexOf("#")>-1&&t.push(r[n])}return t}()},v=function(e){var t=["style","clip-path","src","cursor","fill","filter","marker","marker-start","marker-mid","marker-end","mask","stroke"],n="[*|"+t.join('*="url"], *[*|')+'*="url"]',r=e.querySelectorAll(n);return r},g=function(e,t){var n,r,a=[],o=function(e,n){var r={};r.element=e,r.type=n,r.attributes=[],r.requestedElements=[],r.parentDoc=t;var a;if("xl"===n){if(a=e.attributes["xlink:href"],!a){var o=e.attributes.href;if(!(o&&o.namespaceURI&&o.namespaceURI.indexOf("xlink")>-1))return!1;a=o}r.attributes.push(a),r.requestedElements.push(a.value)}else{a=e.attributes;for(var i=0;i<a.length;i++)for(var l=new RegExp(/url\((.*?)\)/g),s=[];null!==(s=l.exec(a[i].value));)r.attributes.push(a[i]),r.requestedElements.push(s[1].replace(/"/g,""))}return r},i=f(e),l=v(e);for(n=0;n<i.length;n++)r=o(i[n],"xl"),r&&(a.push(r),r=null);for(n=0;n<l.length;n++)r=o(l[n],"url"),r&&(a.push(r),r=null);var s=e.attributes;for(n=0;n<s.length;n++){var c=s[n];if("xlink:href"===c.name)a.push(new o(e,"xl"));else{var u=c.value.match(/url\((.*)\)/);u&&u.length>1&&a.push(new o(e,"url"))}}return a},w=function(e,t){for(var n=e.querySelectorAll("image"),r=0;r<n.length;r++){var a=n[r].getAttributeNS(c,"href"),o=m.URL(a,t).href;a!==o&&n[r].setAttributeNS(c,"href",o)}},b=function(){var e;for(e=0;e<i.length;e++){var t=i[e];if(t.doc){var n=t.innerElements;if(n.length!==t.parsedElements.length){var o;for(o=0;o<n.length;o++){var l=t.doc.getElementById(n[o]);if(l){var c=l.cloneNode(!0);c.id=t.filename+"_"+n[o],w(c,t.base),s.appendChild(c),S(g(c,t)),t.parsedElements.push(n[o]),r--}else console.warn("Couldn't find this element",n[o]),r--}}}}a||r||p()},E=function(e){var t=e.href,n=new XMLHttpRequest;n.onload=function(){if(200===this.status){var n=this.responseText||this.response;if(!n)return;try{e.doc=(new DOMParser).parseFromString(n,"text/html")}catch(o){e.doc=document.implementation.createHTMLDocument(e.filename),e.doc.body.innerHTML=n}e.base=t}else e.doc=null,r-=e.innerElements.length,console.warn("could not load this external document :",t,"\nThose elements are lost : ",e.innerElements.join(" , "));--a||b()},n.onerror=function(n){e.doc=null,r-=e.innerElements.length,console.warn("could not load this external document",t),console.warn("Those elements are lost : ",e.innerElements.join(" , ")),--a||b()},n.open("GET",t),n.send()},y=function(e,t){for(var n=m.URL(e,t.base),o=n.href.substring(n.href.lastIndexOf("/")+1).replace(n.hash,""),l=o.replace(/\./g,"_"),s=n.hash.replace("#",""),c=n.href.replace(n.hash,""),u=l+"_"+s,d=0;d<i.length;d++){var f=i[d];if(f.href===c){if(0===d){if(h.getElementById(s))return s;u="_"+s}return f.innerElements.indexOf(s)<0?(null!==f.doc?r++:console.warn("this element is also lost ",s),f.innerElements.push(s),u):u}}r++,a++;var v={href:c,filename:l,innerElements:[s],parsedElements:[]};return i.push(v),E(v),u},S=function(e){e.length&&!s&&d();var t,n;for(t=0;t<e.length;t++){var r=e[t];for(n=0;n<r.requestedElements.length;n++){var a=r.requestedElements[n],o="#"+y(a,r.parentDoc),i=r.attributes[n],l=i.value.replace(a,o),c=i.name.toUpperCase()===i.name?i.name.toLowerCase():i.name;r.element.setAttribute(c,l)}}};for(n=0;n<t.length;n++)y(t[n][0],{base:t[n][1]});S(g(h,i[0])),a||(r?b():p())};v()}